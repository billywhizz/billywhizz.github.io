<!DOCTYPE html>
<html lang="en">
<head>
<title>Techempower Postgres Audit</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: monospace;
  background-color: #f0f0f0;
  font-size: 10pt;
}
table {
  background-color: white;
  border-spacing: 0px;
}
thead td {
  padding: 4px;
  font-weight: bold;
  background-color: silver;
}
td.pass {
  background-color: green;
  color: white;
  text-align: center;
}
td.fail {
  background-color: red;
  color: white;
  text-align: center;
}
td.broken {
  background-color: blue;
  color: white;
  text-align: center;
}
td.ok {
  background-color: green;
  color: white;
  text-align: center;
}
tbody td.first {
  background-color: #f0f0f0;
  border-bottom: 1px solid #c0c0c0;
}
tbody td.second {
  background-color: white;
  border-bottom: 1px solid #f0f0f0;
}
tbody td {
  padding-top: 2px;
  padding-right: 4px;
}
tbody td.stat {
  text-align: right;
}
div.runDetail {
  position: absolute;
  left: 20px;
  top: 20px;
  width: 300px;
  background-color: white;
  border: 4px solid #f0f0f0;
}
</style>
<script type="text/javascript">

function sortByFramework (a, b) {
  if (a.framework < b.framework) return -1
  if (a.framework > b.framework) return 1
  return 0
}

function sortByTest (a, b) {
  if (a.test < b.test) return -1
  if (a.test > b.test) return 1
  return 0
}

function displayRunDetail (result) {
  const div = document.createElement("div")

  div.className = "runDetail"

  const table = document.createElement('table')
  const head = table.createTHead()
  const body = table.createTBody()
  let newRow, newCell, newText

  newRow = head.insertRow(-1)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('Query')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('Bind')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('Exec')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('Sync')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('Miss')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('Status')
  newCell.appendChild(newText)

  if (result.protocol) {
    for (const conn of result.protocol) {
      const { query, bind, exec, sync, miss, status } = conn
      newRow = body.insertRow(-1)
      newCell = newRow.insertCell(-1)
      newCell.className = 'stat'
      newText = document.createTextNode(query)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = 'stat'
      newText = document.createTextNode(bind)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = 'stat'
      newText = document.createTextNode(exec)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = 'stat'
      newText = document.createTextNode(sync)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = 'stat'
      newText = document.createTextNode(miss)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = 'stat'
      newText = document.createTextNode(status)
      newCell.appendChild(newText)
      newCell.className = status.toLowerCase()
    }
  }

  div.appendChild(table)
  const button = document.createElement("button")
  button.innerText = "OK"
  button.onclick = () => div.remove()
  div.appendChild(button)
  document.body.appendChild(div)
}

function displayResults (results) {
  results.sort(sortByTest)
  results.sort(sortByFramework)
  const table = document.createElement('table')
  const head = table.createTHead()
  const body = table.createTBody()
  let newRow, newCell, newText, anchor

  newRow = head.insertRow(-1)

  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('framework')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('test')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('status')
  newCell.appendChild(newText)

  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('query')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('bind')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('exec')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('sync')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('miss')
  newCell.appendChild(newText)
  newCell = newRow.insertCell(-1)
  newText = document.createTextNode('status')
  newCell.appendChild(newText)

  let current = ''
  let first = false
  for (const result of results) {
    if (current !== result.framework) {
      first = !first
      current = result.framework
    }
    newRow = body.insertRow(-1)

    newCell = newRow.insertCell(-1)
    newCell.className = first ? 'first': 'second'
    anchor = document.createElement('a')
    anchor.innerText = result.framework
    anchor.href = '#'
    anchor.onclick = () => displayRunDetail(result)
    //newText = document.createTextNode(result.framework)
    newCell.appendChild(anchor)

    newCell = newRow.insertCell(-1)
    newCell.className = first ? 'first': 'second'
    newText = document.createTextNode(result.test)
    newCell.appendChild(newText)
    newCell = newRow.insertCell(-1)
    newText = document.createTextNode(result.status)
    newCell.appendChild(newText)
    newCell.className = result.status.toLowerCase()

    let query = 0
    let bind = 0
    let exec = 0
    let miss = 0
    let sync = 0
    let status = 'ok'
    if (result.protocol && result.protocol.length) {
      for (const conn of result.protocol) {
        if (status === 'ok' && conn.status !== 'ok') status = conn.status
        query += conn.query
        bind += conn.bind
        exec += conn.exec
        sync += conn.sync
        miss += conn.miss
      }

      newCell = newRow.insertCell(-1)
      newCell.className = first ? 'first': 'second'
      newCell.className += ' stat'
      newText = document.createTextNode(query)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = first ? 'first': 'second'
      newCell.className += ' stat'
      newText = document.createTextNode(bind)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = first ? 'first': 'second'
      newCell.className += ' stat'
      newText = document.createTextNode(exec)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = first ? 'first': 'second'
      newCell.className += ' stat'
      newText = document.createTextNode(sync)
      newCell.appendChild(newText)
      newCell = newRow.insertCell(-1)
      newCell.className = first ? 'first': 'second'
      newCell.className += ' stat'
      newText = document.createTextNode(miss)
      newCell.appendChild(newText)

      newCell = newRow.insertCell(-1)
      newText = document.createTextNode(status)
      newCell.appendChild(newText)
      newCell.className = status.toLowerCase()

    }

  }

  document.body.appendChild(table)
}

async function run () {
  const res = await fetch('results.json')
  const results = await res.json()
  displayResults(results)
}

window.onload = () => {
  run().catch(err => console.error(err.stack))
}
</script>
</head>
<body>

</body>
</html>
